---
title: "Introduction to hisafer"
output: rmarkdown::html_vignette #pdf_document
vignette: >
  %\VignetteIndexEntry{hisafer}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

hisafer is an R toolbox for the Hi-sAFe biophysical agroforestry model. It provides functions for defining, building, running, reading, analyzing, and plotting Hi-sAFe simulaitons. The first step to using hisafer is to install and load the library, which is currently available from github. You need the devtools package to do this from within R.

```{r, eval = FALSE}
install.packages("devtools")
library(devtools)
install_github("kevinwolz/hisafer")
```
```{r}
library(hisafer)
```

## Six Steps to Hi-sAFe Experimentation
hisafer tools are organized via the six main steps of experimentation with Hi-sAFe: Define, Build, Run, Read, Diagnostics, Analysis. While hisafer can be used to interact with Hi-sAFe at any of these steps independently, enhanced functionality is available when using hisafer to interact with Hi-sAFe from the beginning.

### 1. Create a TEMPLATE
The first and most important step to running Hi-sAFe simulations is to create a template Hi-sAFe simulation directory. This template will be the foundation of simulations/experiments that you define in the next step. The template directory contians all files available for use when defining simulations/experiments, and the values of parameters in each file are the default values that will be used if other values are not defined in the next step. 

The template directory structure for the latest version of Hi-sAFe (v3.2) has all of the following containing within a single folder:

- `template.sim` - the template .SIM file
- `template.pld` - the template .PLD file
- `weather.wth` - a default .WTH file
- `treeSpecies/` - a folder containing all of the individual .TREE files that will be available for use
- `cropSpecies/` - a folder containing all of the individual .PLT files that will be available for use
- `cropInterventions/` - a folder containing all of the individual .TEC files that will be available for use
- `generalParameters/` - a folder containing a single `tempopar.sti` file, which contains general STICS parameters
- `exportParameters/` - a folder containing all of the individual .PRO files that will be available for use

Luckily, hisafer already has several built-in template directories available for you. You can use these in the next step simply by providing the name of the template rather than a path to a custom template directory. The built-in templates are:

- `agroforestry_default` - a simple alley cropping template, with trees spaced at 9m x 13m and a durum wheat alley crop
- `forestry_default` - a simple forestry template, with trees spaced at 3m x 5m and an understory of bare soil
- `monocrop_default` - a simple, single-celled monocrop template with durum-wheat
- `restinclieres_agroforestry` - a template based on the agroforestry calibration simulation of Hi-sAFe in Plot A2 at Restinclieres in Southern France
- `restinclieres_monocrop`- a template basd on the monocrop calibration simulation of Hi-sAFe in Plot A2 at Restinclieres in Southern France

<!-- hisafer runs many checks on supplied parameters during the define phase. These checks can by (optionally) enhanced by including annotated contraints within the .SIM, .PLD, and .TREE files. These annotations take the form of commented strings on each line after the defined parameter. To define an allowed range............ --> 

### 1. DEFINE an experiment
In this step, you willdefine one or more Hi-sAFe "simulations". Simulations are definied by specifying any number of Hi-SAFe input parameters from the .SIM, .PLD, or .TREE files that you wish to vary. Any Hi-SAFe input parameters not specified will simply inherit the default values from the files within the specfied template directory. 

To see which Hi-SAFe input parameters are modifiable in your template, use `hisafe_params()`. You can modifty the `template` argument of `hisafe_params()` to be any of the other hisafer templates or a string to the path of your custom template. By default, `hisafe_params()` just provides the names of supported parameters. To also see the default values, range of allowed values, and range of suggested values for all parameters, use `hisafe_params("all")`
 
Once you know which parameter(s) you want to customize, you can define a Hi-sAFe simulation or experiment using `define_hisafe()`. Let's start with just a simple Hi-sAFe simulation in which we only want to customize **latitude** and **treeLineOrientation**. The `path` argument specifies the path (relative or absolute) where the simulation is to be built in the next step. The `profiles` arguement specifies which Hi-sAFe export profiles are to be exported by Hi-sAFe ("all" specifies that all available profiles will be exported). Be careful when using "all", as this will include the very large "cells" and "voxels" outputs, slowing your Hi-sAFe simulations dramatically. To see which Hi-sAFe output profiles are supported and their export frequency, use `hisafe_profiles()`. The `template` argument specifies which template directory will serve as the foundation for the defined simulation. All other arguments can specify any number of Hi-sAFe input parameters (named, spelled, and capitalized correctly!). The only additional input parameter that is available but not part of the input files is **weatherFile**, which specifies a path to a .WTH file to use. 

```{r, error = TRUE, purl = FALSE}
hip_sim <- define_hisafe(path     = "./simulations",
                         profiles = "all",
                         template = "agroforestry_default",
                         latitude = 60, 
                         treeLineOrientation = -180)
```

Oops! It looks like **treeLineOrientation** must be between 0 and 359. This error message is just one example of a suite of checks that `define_hisafe()` runs when attempting to define a simulation. Informative error messages are provided to help guide you in fixing any issues. Let's double check the details on the **treeLineOrientation** parameter.

```{r}
hisafe_params("treeLineOrientation", template = "agroforestry_default")
```

Okay, let's try again using a new value for **treeLineOrientation**.

```{r}
hip_sim <- define_hisafe(path     = "./simulations",
                         profiles = c("annualplot", "annualtree", "annualcrop", 
                                      "plot", "trees", "climate", "monthCells"),
                         template = "agroforestry_default",
                         latitude = 60, 
                         treeLineOrientation = 90)
hip_sim
```

We can now see a defined Hi-sAFe simulation, which is contained within a `hip` object (for "Hi-sAFe Input Parmaeters"). The main feature of a `hip` object is the `exp.plan`. Each row of the `exp.plan` object describes a single Hi-sAFe simulation, and each column provides the value of a Hi-sAFe input parameter. If not provided manually, a default **SimulationName** is provided for each simulation within the `hip` object.

Let's try something more complicated now. Most Hi-sAFe simulations are run in groups that vary one or more parameters over a range of values. A group of multiple, related simulations is called an "experiment". We can also use `define_hisafe()` to define an experiment by simply providing multiple values for one or more parameters. The arguments to `define_hisafe()` are the same when defining an experiment, except that there is also an optional argument to name the experiment via `exp.name`. If not provided, a default name is used. 

There are two methods for defining an experiment, depending on if the `define_hisafe()` agrument `factorial` is `TRUE` or `FALSE`. 

If `factorial` is `FALSE`, the default, then parameter values are recycled (i.e. such as for default behavior of `data.frame()`).

```{r}
hip_exp_F <- define_hisafe(path      = "./simulations",
                           profiles  = c("annualplot", "annualtree", "annualcrop", 
                                         "plot", "trees", "climate", "monthCells"),
                           template  = "agroforestry_default",
                           exp.name  = "lat-orient",
                           factorial = FALSE, 
                           latitude  = c(30, 60),
                           treeLineOrientation = c(0,90))
hip_exp_F$exp.plan
```

In this case, you can see that there are two simulations in the resulting `hip`, one with **latitude**=30 and **treeLineOrientation**=0, and the other with **latitude**=60 and **treeLineOrientation**=90.

If `factorial` is `TRUE`, then a factorial experiment is created, in which a simulation is defined for each possible combination of supplied values.

```{r}
hip_exp <- define_hisafe(path      = "./simulations",
                         profiles  = c("annualplot", "annualtree", "annualcrop", 
                                       "plot", "trees", "climate", "monthCells"),
                         template  = "agroforestry_default",
                         exp.name  = "lat-orient",
                         factorial = TRUE, 
                         latitude  = c(30, 60),
                         treeLineOrientation = c(0,90))
hip_exp$exp.plan
```

In this case, you can see that there are four simulations in the resulting `hip`, one for each possible combination of the supplied values of **latitude** and **treeLineOrientation**. We'll use this `hip` object for moving on to the next step.

You can also use `define_hisafe_file()` to directly read an `exp.plan` object from a *csv* file. For more information on this approach, see `?define_hisafe_file`.


### 2. BUILD simulation folders/files
There is only one build function, and it only takes a single agrument: `build_hisafe()`. This function takes a `hip` object as an input and builds the actual folders/files on your computer that Hi-sAFe will read to run. These directories will be created in the location specififed in the `path` portion of the `hip` object. 

```{r, eval = FALSE}
build_hisafe(hip = hip_exp)
```

In addition to building the folder/file structure, `build_hisfe()` also creates a map of each scene within the respective simulation folders. It is highly recommended to check these maps prior to running your simultions to ensure that the scene was built as intended.


### 3. RUN simulations
Once the Hi-sAFe folders/files are created on your comupter, you are ready to run Hi-sAFe! Simulations are run using `run_hisafe()`.  To run our previous experiment on **latitude** and **treeLineOrientation** we will use `run_hisafe()` by providing: 

- The `hip` object.
- A character vector of the **SimulationName** of which simulations to run using `simu.names`
- A logical `parallel` indicating whether or not to run multiple simulations in parallel on your computer. The default is `FALSE`, but it is highly encouraged to use parallel processing if your computer as the capacity! If `parallel` is `TRUE`, one fewer than the total number of available cores will be used. Alternatively, the number of cores to use can be specified directly via `num.cores`.
- The path to the Capsis folder on your computer via `capsis.path`. This is where hisafer can find Capsis and the Hi-sAFe model. 

```{r, eval = FALSE}
run_hisafe_exp(hip         = hip_exp,
               simu.names  = "all",
               parallel    = TRUE,
               capsis.path = "/Applications/Capsis/")
```

`run_hisafe()`can also be used without a `hip` object to run Hi-sAFe simulations that were not create using hisafer. To do this, you must supply the `path` to the directory where the simulation folders are located. Just make sure the simulation folder/file structures are correct!

```{r, eval = FALSE}
run_hisafe(path        = "./simulations"
           simu.names  = "Sim_From_Kevin",
           capsis.path = "/Applications/Capsis/")
```


### 4. READ output data
Hi-sAFe can generate quite a lot of output data. All of this data is created within a set of (large) text files, which can be difficult to navigate without hisafer. During this step, hisafer reads all of this output data into R for easy manipulation and analysis. To read Hi-sAFe output data use `read_hisafe()`. The only required input is a `hip` object or, alternatively, a `path` to the directory containing the simulation folders can by manually provided. You can also specify a subset of simulations to read via `simu.names`. Finally, you can specify which Hi-sAFe output profiles to read in using `profiles`. While the default is to read all profiles, you may not want to read in any created "cells" or "voxels" data if you simply want to analyze annual data. 

The resulting object created by `read_hisafe()` is a `hop` obeject (for "Hi-sAFe OutPut") of class "hop". This is a list of 16 data frames (tibbles): 

- `annualtree`
- `annualcrop`
- `annualplot`
- `trees`
- `plot`
- `climate`
- `roots`
- `monthCells`
- `cells`
- `voxels`
- `variables` - variable descriptions and units from all profiles
- `plot.info` - plot geometry data for each simulation
- `tree.info` - tree species and location data for each simulation
- `exp.plan` - the `exp.plan` of the hip object that generated the simulation
- `path` - the paths to the simulation folders
- `exp.path` - the path to the experiment folder

If any Hi-sAFe output profiles specified by `profiles` were not created when Hi-sAFe was run, a warning will notify you. For any profiles not created by Hi-sAFe or not selected for reading, the the associated list components will be empty tibbles.

*WARNING: Depending on the number of simulations, length of simulations, and which output profiles are specified, reading in Hi-sAFe data can take a few minutes!*

To run our previous experiment on **latitude** and **treeLineOrientation** we will use `read_hisafe()` as follows: 

```{r, eval = FALSE}
hop_exp <- read_hisafe(hip = hip_exp)
```

```{r, echo = FALSE}
#hop_exp <- read_hisafe_example(show.progress = FALSE)
#save(hop_exp, file = paste0(system.file("extdata", "vignette_output", package = "hisafer"), "/vignette_hop.Rdata"))
load(paste0(system.file("extdata", "vignette_output", package = "hisafer"), "/vignette_hop.Rdata"))
```


### 5. Data DIAGNOSTICS
Prior to performing any analyses using your `hop` data, it is highly recommended to check some basic diagnostics on your simluations to ensure that the simulations ran as expected. To do so, hisafer provides some basic diagnostic functions that allow you to compare you various simulations side by side:

- `diag_hisafe_ts()` - can plot a timeseries plot for each variable in the "annualtree", "annualplot", "trees", "plot", and  "climate" data of a `hop` object.
- `diag_hisafe_monthcells()` - plots a full range of tile plots for each variable in the "monthCells" data of a `hop` object.

### 6. ANALYZE data
There are many different types of analyses that can be performed with Hi-sAFe output data. hisafer contains an ever-growing suite of data analysis functions.

Here are some basic plotting functions that can plot individual variables: 

- `plot_hisafe_ts()` - plots "annualtree", "annualplot", "trees", "plot", or  "climate" timeseries data
- `plot_hisafe_monthcells()` - plots tile plots of "monthCells" data
- `plot_hisafe_cells()` - plots tile plots of "cells" data
- `plot_hisafe_voxels()` - plots tile plots of "voxels" data

```{r}
plot_hisafe_ts(hop = hop_exp, variable = "dbh", profile = "annualtree")
```

```{r, fig.height = 10}
plot_hisafe_monthcells(hop       = hop_exp, 
                       variable  = "monthRelativeDirectParIncident",
                       colfacet  = "Year",
                       rowfacet  = "Month",
                       sim.names = "Sim_1",
                       years     = seq(0, 30, 5),
                       months    = 1:12)
```

You can also compare the major Hi-sAFe "cycles" among your simulations by using `plot_annual_cycle()` and `plot_daily_cycle()`. Supported "cycles" include carbon, water, nitrogen, and light. 
```{r, eval = FALSE}
plot_annual_cycle(hop = hop_exp, cycle = "carbon")
```
```{r, eval = FALSE}
plot_annual_cycle(hop = hop_exp, cycle = "nitrogen")
```
```{r, eval = FALSE}
plot_annual_cycle(hop = hop_exp, cycle = "water")
```
```{r, eval = FALSE}
plot_annual_cycle(hop = hop_exp, cycle = "light")
```

By default, every hisafer analysis function returns a `ggplot` object. Each function, however, has an arguement `plot`, whch can be set to `FALSE` to instead return the data (a tibble) that would create the plot. 

Many custom analyses will be performed on an individual profile/component of a `hop` object. These can easily be accessed using the `$` operator. For example, to access the "plot" data of previous experiment on **latitude** and **treeLineOrientation**:

```{r, eval = FALSE}
hop_exp$plot
```

Sometimes, during the Analysis phase, you will realize that the values of **SimulationName** that you provided during the define phase are not quite what you wanted. To rename each **SimulationName** in your `hop` object, you can use `simu_rename()`.

You may also realize that you want to either remove some simulations from your `hop` object or even merge several `hop` objects togeter. These goals can be accomplished using the `hop_filter()` and `hop_merge()` functions. 

### 7. FACE experiments
One very special case of analyzing Hi-sAFe simulations occurs when you want to compare one or more agroforestry simulations with a forestry control simulation and a monocrop control simulation. hisafer refers to this type of experiment as a "FACE" (Forestry-Agroforestry-Crop Experiment). The first step in this special analysis is to create a `face` object, which is a modified `hop` objects that merges three individual `hop` objects of the respective systems:

- agroforestry
- forestry
- monocrop

To create a `face` object, use `create_face()`and supply the three required `hop` objects along with a path to a diretory where you want all FACE analyses to be saved. The agroforestry `hop` can contain any number of agroforestry simulations, but the forestry `hop` and monocrop `hop` can only contain a single simulation each. 

```{r, echo = FALSE}
load(paste0(system.file("extdata", "vignette_output", package = "hisafer"), "/vignette_face.Rdata"))
```

```{r, eval = TRUE}
myface <- create_face(agroforestry = AF.hop, 
                      forestry     = FC.hop, 
                      monocrop     = CC.hop, 
                      face.path    = "./simulations")
```

Once you have a `face` object, the most common analysis is to calculate the various LER metrics of the agroforestry systems. You can do this using `LER()`.
```{r, eval = FALSE}
LER(face = myface)
```

Furthermore, just as for normal `hop` objects, you can also use `plot_annual_cycle()` and `plot_daily_cycle()` to compare the simulations in a `face` object. 
```{r, eval = TRUE}
plot_annual_cycle(hop = myface, cycle = "carbon")
```
```{r, eval = TRUE}
plot_annual_cycle(hop = myface, cycle = "light")
```

### Notes
*hisafer utilizes the tidyverse approach to R programming and data manipulation. While most consequneces of this approach are behind the scenes, one obvious example to users is that outputs from most hisafer fucntions are tibbles rather than simple data frames. This has little practical impact on your use of hisafer, but should improve your overall experience.*
